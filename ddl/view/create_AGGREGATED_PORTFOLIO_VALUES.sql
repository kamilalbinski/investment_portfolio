DROP VIEW IF EXISTS AGGREGATED_PORTFOLIO_VALUES;

CREATE VIEW AGGREGATED_PORTFOLIO_VALUES AS

WITH daily_portfolio_values AS (
    SELECT
        TIMESTAMP,
        ACCOUNT_OWNER,
        SUM(AGGREGATED_VALUE) AS AGGREGATED_VALUE
    FROM
        AGGREGATED_VALUES
    GROUP BY
        TIMESTAMP, ACCOUNT_OWNER
),
total_values AS (
    SELECT
        TIMESTAMP,
        'None' AS ACCOUNT_OWNER,
        SUM(AGGREGATED_VALUE) AS AGGREGATED_VALUE
    FROM
        daily_portfolio_values
    GROUP BY
        TIMESTAMP
)
SELECT *
FROM daily_portfolio_values
UNION ALL
SELECT *
FROM total_values
ORDER BY TIMESTAMP, ACCOUNT_OWNER